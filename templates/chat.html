<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - YouTube Q&A Bot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container chat-container">
        <div class="header">
            <h1>üé¨ YouTube Q&A Bot</h1>
            <a href="/" class="back-btn">‚Üê New Video</a>
        </div>
        
        <div id="chatbox" class="chatbox">
            <div class="message bot-message">
                üëã Video loaded! Ask me anything about it.
            </div>
        </div>
        
        <div class="input-section chat-input">
            <input 
                type="text" 
                id="question" 
                placeholder="Ask a question..."
            >
            <button id="askBtn" onclick="askQuestion()">
                Send
            </button>
        </div>
    </div>

    <script>
        async function askQuestion() {
            const input = document.getElementById('question');
            const question = input.value.trim();
            const chatbox = document.getElementById('chatbox');
            const btn = document.getElementById('askBtn');
            
            if (!question) return;
            
            // Add user message
            addMessage('ü§î ' + question, 'user-message');
            
            // Clear input
            input.value = '';
            btn.disabled = true;
            
            // Add loading
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message bot-message';
            loadingDiv.id = 'loading-msg';
            loadingDiv.innerHTML = '‚è≥ Thinking...';
            chatbox.appendChild(loadingDiv);
            chatbox.scrollTop = chatbox.scrollHeight;
            
            try {
                console.log('Sending question:', question);
                
                const response = await fetch('/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ question: question })
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Response data:', data);
                
                // Remove loading
                document.getElementById('loading-msg').remove();
                
                if (data && data.success) {
                    addMessage('üí° ' + data.answer, 'bot-message');
                } else {
                    const errorMsg = data ? data.error : 'Unknown error';
                    addMessage('‚ùå ' + errorMsg, 'bot-message error');
                }
                
            } catch (error) {
                console.error('Fetch error:', error);
                
                // Remove loading
                const loadingEl = document.getElementById('loading-msg');
                if (loadingEl) loadingEl.remove();
                
                addMessage('‚ùå Error: ' + error.message, 'bot-message error');
            }
            
            btn.disabled = false;
            input.focus();
        }
        
        function addMessage(text, className) {
            const chatbox = document.getElementById('chatbox');
            const div = document.createElement('div');
            div.className = 'message ' + className;
            div.textContent = text;
            chatbox.appendChild(div);
            chatbox.scrollTop = chatbox.scrollHeight;
        }
        
        // Enter key support
        document.getElementById('question').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                askQuestion();
            }
        });
        
        // Focus on load
        document.getElementById('question').focus();
    </script>
</body>
</html>